<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<style>
			iframe {
				width: 0%;
				height: 0%;
				overflow-clip-margin: unset !important;
				overflow: visible !important;
				border-width: 0px;
				border-style: inset;
				border-color: initial;
				border-image: initial;
			}

			.iframe {
				width: 100%;
				height: 100%;
			}

			html {
				height: 100%;
			}

			body {
				height: 100%;
				margin: 0px;
				overflow: hidden;
			}
		</style>
		<script type="module">
			window.addEventListener("contextmenu", (e) => e.preventDefault(), false);
			const appWindow = window.__TAURI__.window;
			appWindow.getCurrent().listen("tauri://close-requested", async function(event) {

				console.log('close-requested', event);
				const confirmed = await window.__TAURI__.dialog.confirm('你确认要关闭此应用吗？');
				if (!confirmed) {
					console.log('Q result - false', confirmed);
				} else {
					appWindow.getCurrent().close();
					console.log('Q result - true', confirmed);
					fetch('http://127.0.0.1:8000/close').then(response => {
						if (response.ok) {
							return response.json();
						} else {
							throw new Error(response.statusText);
						}
					})
				}
			});
		</script>
		<script>
			function timeoutFetch(timeout = 500) {

				return (url, option = {}) => {
					const controller = new AbortController()
					option.signal = controller.signal
					// 设置一个定时器，超时后调用abort方法结束当前请求
					const tid = setTimeout(() => {
						console.error(`Fetch timeout: ${
			     url}`)
						controller.abort()
					}, timeout)
					return fetch(url, option).finally(() => {
						clearTimeout(tid)
					})
				}
			}

			async function to_load() {
				let frame = document.querySelector('iframe');
				try {
					// await fetch(frame.src);
					await timeoutFetch(200)(frame.src);
					frame.classList.add('iframe');
				} catch (e) {
					frame.src = frame.src;
					console.log("尝试重载", new Date())
				}
				timeoutFetch();
			}

			function reloadFrame() {
				// setTimeout(to_load, 500);
				// 本身有超时时间，不必等待
				to_load();
			}
		</script>
	</head>
	<body style="background-color: aquamarine;">
		<script>
			document.addEventListener("DOMContentLoaded", () => {
				let frame = document.querySelector('iframe');
				// 必须设置随机参数以免无法刷新，而且要避免重定向
				frame.src = `http://127.0.0.1:8000/main/main.html?random=${Math.random()}`;
			}, false);
			// 阻止不合时宜的右键菜单
			// window.addEventListener("contextmenu", (e) => e.preventDefault(), false);
		</script>
		<iframe onload="reloadFrame()"></iframe>

	</body>
</html>